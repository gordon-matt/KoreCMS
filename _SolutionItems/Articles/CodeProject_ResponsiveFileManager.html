<h1>Using Responsive File Manager in ASP.NET MVC</h1>

<h2>Background</h2>
<p>
    About a year ago I started my own open source CMS project in ASP.NET MVC (soon to be released) and as any good CMS needs a file manager,
    I began looking around for open source projects. I was somewhat disappointed in the fact that there's not much available. After
    searching for a while, I managed to find what seemed to be perfect: Responsive File Manager, by Alberto Peripolli
    (see: <a href="http://www.responsivefilemanager.com/">http://www.responsivefilemanager.com/</a>. To my disappointment, I discovered it
    was written in PHP and not JavaScript as I had hoped. I settled for the next best thing; ELFinder. ELFinder is good for what it is,
    but also takes a bit of work to get up and running. I found ELFinder Connector for .NET and used that. All was working fine, but I
    still wasn't very happy - not with the look of the thing or various issues I won't go into.
</p>
<p>
    In any case, I continued work on my CMS and decided to forget about this issue for the time being. Fast forward a year to just a
    couple of weeks ago: I decided to look around again and see if anything was available. I even searched the
    <a href="http://codecanyon.net/search?platform=jQuery&term=file+manager&utf8=%E2%9C%93">envato market</a> in hopes of finding
    something to purchase. Alas, no luck. In 2015, we are still sorely in need of a decent file manager (at least for non-PHP developers
    that is). So I decided to take another crack at Responsive File Manager - firstly to see how complex it was and if I should attempt
    to rewrite it in JQuery.
</p>
<p>
    It was at this time I had a thought; .NET now has compilers for Ruby (Iron Ruby), Python (Iron Python) and so forth... I wondered if
    there was something for PHP. A few minutes of Googling later and bingo! I discovered Phalanger - the PHP compiler for .NET. I spent
    the next few days struggling with various issues to make it work just right, but I am happy to say, I now have Responsive File Manager
    working very well within my ASP.NET MVC site. Follow the steps below and you can too...
</p>

<h2>Installation &amp; Configuration</h2>
<p>
    <ol>
        <li>
            First of all you should download Responsive File Manager, which you can do so from the GitHub page here:
            <a href="https://github.com/trippo/ResponsiveFilemanager">https://github.com/trippo/ResponsiveFilemanager</a>
        </li>
        <li>
            Extract the files and copy the <b>filemanager</b> folder to the root of your site.
            Note: If you try to copy it anywhere else, it seems to return incorrect relative URLs.
        </li>
        <li>
            Download Phalanger 4.0 from the following link:
            <a href="https://github.com/DEVSENSE/Phalanger">https://github.com/DEVSENSE/Phalanger</a>
        </li>
        <li>
            Open the source code and find the function <code>imagecolorsforindex()</code> in <b>/Extensions/Gd2/PhpGd.cs</b>. You will
            notice that it is not implemented. Copy the code from this pull request:
            <a href="https://github.com/DEVSENSE/Phalanger/pull/19/files">https://github.com/DEVSENSE/Phalanger/pull/19/files</a>. Here it is
            below to save you searching:
<pre lang="xml">
[ImplementsFunction("imagecolorsforindex")]
public static PhpArray imagecolorsforindex(PhpResource im, int col)
{
    // implementation from:
    //  https://github.com/DEVSENSE/Phalanger/pull/19/files
    var im1 = (PhpGdImageResource)im;
    var arr = new PhpArray();
    var entries = im1.Image.Palette.Entries;
    Color color;
    if (entries.Length > 0)
    {
        color = entries[col];
    }
    else
    {
        color = Color.FromArgb(col);
    }
    arr["red"] = (int)color.R;
    arr["green"] = (int)color.G;
    arr["blue"] = (int)color.B;
    arr["alpha"] = (int)color.A;
    return arr;
}
</pre>
            This prevents a particular compiler error. If I recall correctly, it's used when handling bitmap files.
        </li>
        <li>
            Build the source code in release mode and reference the DLLs from your project. Note that you will need
            to have opened visual studio with Administrator privileges or you will get build errors. Also note, I have not yet
            determined exactly which DLLs are required and which can be ignored. You can definitely ignore the SQL and Zip DLLs though.
        </li>
        <li>
            You will need the following added to your <b>web.config</b> file
<pre lang="xml">
&lt;configuration&gt;
    &lt;configsections&gt;
        &lt;section name=&quot;phpNet&quot; type=&quot;PHP.Core.ConfigurationSectionHandler, PhpNetCore, Version=4.0.0.0, Culture=neutral, PublicKeyToken=0a8e8c4c76728c71&quot; /&gt;
    &lt;/configsections&gt;
    &lt;phpnet&gt;
        &lt;classlibrary&gt;
            &lt;add assembly=&quot;PhpNetClassLibrary, Version=4.0.0.0, Culture=neutral, PublicKeyToken=4af37afe3cde05fb&quot; section=&quot;bcl&quot; /&gt;
            &lt;add assembly=&quot;PhpNetMbstring, Version=4.0.0.0, Culture=neutral, PublicKeyToken=2771987119c16a03&quot; /&gt;
            &lt;add assembly=&quot;PhpNetGd2, Version=4.0.0.0, Culture=neutral, PublicKeyToken=2771987119c16a03&quot; /&gt;
        &lt;/classlibrary&gt;
    &lt;/phpnet&gt;
    &lt;system.webserver&gt;
        &lt;handlers&gt;
            &lt;add name=&quot;Phalanger&quot; path=&quot;*.php&quot; verb=&quot;*&quot; type=&quot;PHP.Core.RequestHandler, PhpNetCore, Version=4.0.0.0, Culture=neutral, PublicKeyToken=0a8e8c4c76728c71&quot; resourcetype=&quot;Unspecified&quot; precondition=&quot;integratedMode&quot; /&gt;
        &lt;/handlers&gt;
    &lt;/system.webserver&gt;
    &lt;runtime&gt;
        &lt;assemblybinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;
            &lt;probing privatepath=&quot;Phalanger&quot; /&gt;
	    &lt;/assemblybinding&gt;
    &lt;/runtime&gt;
&lt;/configuration&gt;
</pre>
        </li>
        <li>
            To prevent various errors, find and remove all <b>exit;</b> commands in the file manager's .php files.
            Note: I have no experience with PHP so perhaps I should have taken another approach to solving this, but so
            far I have not seen any bad side effects of doing so. My guess is these <b>exit;</b> keywords are not needed
            when using Phalanger.
        </li>
        <li>
            There were two functions being called by the file manager which are not yet implemented by Phalanger. The first of these
            is the following: <code>ini_set('memory_limit' ...</code>. This appears in the <code>image_check_memory_usage</code> function on
            line 567 of <b>/filemanager/include/utils.php</b>. This function is called when the file manager is creating thumbnails.
            Apparently this is not required when using Phalanger, since simply returning <b>true</b> at the top of the function works just fine.
        </li>
        <li>
            Again in <b>utils.php</b> we want to change one more thing: on Windows (or at least on my machine), the <code>rename_folder</code>
            function fails with a permissions exception when it calls PHP's <code>rename</code> function. Oddly, the <code>rename</code>
            function only seems to fail when renaming folders; files are fine. So, replace the last line:
            
            <pre lang="php">return rename($old_path, $new_path);</pre>

            with:

<pre lang="php">
if (!mkdir($new_path, 0755, true))
{
    return false;
}
rcopy($old_path, $new_path, true);
        
return deleteDir($old_path);
</pre>
            And that works fine.
        </li>
        <li>
            Find the <code>resizeImage</code> function near thetop of the file in <b>/filemanager/include/php_image_magician.php</b>.
            At the end of this function, comment out the following 3 lines:

<pre lang="php">
if ($sharpen && in_array($this->fileExtension, $this->sharpenArray))
{
    $this->sharpen();
}
</pre>
            This needs to be commented out because the <code>sharpen()</code> function makes a call to <code>imageconvolution</code> which is
            something not yet supported by Phalanger. Luckily for us, ignoring this doesn't seem to make any noticeable difference.
        </li>
    </ol>

    That should be all you need to get started.
</p>

<h2>Issues</h2>
<p>
    So far pretty much everything seems to be working well, but I will note that I didn't bother checking the Aviary image editing
    features because I have no need of them at this point. It is likely there will be a few issues to fix with that too. I simply
    turned off that feature in the <b>/config/config.php</b> file by setting <b>aviary_active</b> to <b>false</b>.
</p>

<h2>Final Thoughts and Conclusion</h2>

<p>
    It may be interesting to note that I originally believed I would need a PHP view engine, such as the one on Codeplex at
    <a href="https://phpviewengine.codeplex.com/">https://phpviewengine.codeplex.com/</a> which makes use of Phalanger as well. To my
    satisfaction this is not the case; there is absolutely no need whatsoever for a PHP view engine; you can continue using your
    <b>.cshtml</b> files as you normally would. However, I do find the thought of adding a PHP view engine alongside the Razor one
    to be very intriguing. Those more interested should have some fun with that.
</p>
<p>
    My hat off to the Phalanger team and to Alberto Peripolli for his excellent file manager. Now us .NET developers can have the best
    file manager in our MVC applications (likely Web Forms would work just as well too). If you have any comments or any suggestions
    on improving upon my work, please do share with the rest of us. My hope is we'll all eventually end up with a perfect
    implementation of the Responsive File Manager in ASP.NET.
</p>
<p>Enjoy!</p>